\section{Template Extraction}
Before we can extract template images for cross-correlation, they must first be
identified in the source spectrograms.
For this to be viable at any level of consistency, spectrograms must undergo
noise reduction and segmentation.
This section details the mechanisms developed for preprocessing spectrogram
images and filtering segments so that only relevant templates are included for
extraction.

Each spectrogram is processed in sequence using functionality provided by the
Python OpenCV library, and immediately stored on disk.
Parallelisation is possible here, but the computational cost of this stage is
not large enough to justify sparing development time on this aspect at the time.

\input{tex/sgram_preprocessing}

\subsection{Basic Selection and Extraction}\label{sec:template_select}
With optimal results the segments represent parts of song at the desired
granularity, from elements to phrases.
This is often not the case however.
Noise may persist after preprocessing, and new deformations may appear, such as
incorrectly joined or incomplete segments.

Some effort is taken to reduce the number of undesireable templates.
In addition to noise, undesireable templates include extremely specific or
extremely generalised templates.

For example, if a sound is featured in a single instance of bird song, but not
in any other recording of songs of that species, then it is an extreme outlier,
which may occur due to a bird's individual expression or external sources.
It is non trivial to detect outliers during feature extraction, but because
random forests are generally insensitive to this type of outlier, we do not
treat these in this stage.

Generalised, or weak templates are easier to detect.
Such templates will have a very faint structure (low contrast), or a complete
lack of structure.
These may be analysed directly and ignored, as they are likely to correlate,
although very weakly, to the majority of spectrograms irrespective of the
species.

Although these rejections bring a theoretical boost to classifier accuracy and
performance, they mainly benefit performance by reducing the number of
cross-correlations computed.

\begin{figure}[h]
  \centering
  \caption{Spectrogram of a birdx featuring extremely small, large, and weak
  templates}
\end{figure}

\subsubsection{Selection mechanism}
Complete elimination of all undesireable features is impossible without also
removing desireable features.
A balance must therefore be struck, in both preprocessing and selection stages.
Performing selection manually is infeasable given the quantity
of pixel segments.
Selection is therefore done automatically by considering the dimensionality and
pixel values of each template.
Results are shown in Figure~\ref{fig:template_select_effects}\\

Templates with the following properties are automatically rejected:
\begin{itemize}[noitemsep]
  \item \textbf{Area smaller than 50 pixels:} Templates with small dimensions
    are too small to be of any significance and are most likely noise or
    artefacts from preprocessing;

  \item \textbf{Area larger than 10000 pixels:} Templates with extremely large
    dimensions are most likely artefacts from preprocessing, high intensity
    noise or continuous external noises.
    It is possible for sections of song to be merged together into a single
    pixel region due to preprocessing errors.

  \item \textbf{Maximum template intensity lower than average intensity of the
    spectrogram:}
    Templates with significantly low intenstity or contrast are too general to
    become useful features.
    This filter eliminates some of these templates.
\end{itemize}

\begin{figure}[!htb]
  \centering
  \begin{subfigure}[b]{1.0\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \begin{subfigure}[b]{1.0\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \caption{A noisy spectrgoram before (a) and after (b) template selection}
  \label{fig:template_select_effects}
\end{figure}

\subsubsection{Extraction mechanism}\label{sec:extract}

A bounding box is computed for the contours of each segment, which is then used
to extract a template from the original spectrogram image.
Once selection is performed for a particular pixel region, it's bounding box is
expanded by 10 pixels in each direction, and that region is extracted from the
original, unprocessed spectrogram.
This forms a single template.
The template is then blurred using a Gaussian filter with a sigma of 1.5
(Figure~\ref{fig:extract_blur}).

Blurring the template allows us to reduce its size, which brings performance
boosts to template matching.
Blurring the template also improves it's generality, which makes matches more
likely.
Care is taken to ensure that templates do not become overly generic, resulting
in general ambiguity.
The same operation is made to the spectrograms subject to cross-correlation
mapping in order to ensure consistency.

\begin{figure}[h]
  \centering
  \begin{subfigure}[h]{0.5\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \begin{subfigure}[h]{0.5\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \caption{A template before (a) and after (b) gaussian filtering}
  \label{fig:extract_blur}
\end{figure}

\subsection{Advanced Template Elimination}
It is desireable to reduce the template count further by recognizing aspects which
make for good templates. This subsection outlines some speculative methods for
selecting better templates.

\subsubsection{Spatial inclusion}
Imperfections in the preprocessing mechanism leads to errorneous pixel segments.
Incorrect gaps, joins and other inconsistencies in structure persist or
materialise.
If ignored, these will be extracted along with valid templates.
As long as these are infrequent, the additional templates will factor more as
a performance penalty than an accuracy reduction.

In many of these cases, one template's bounding box intersects or is contained
entirely within another template's bounding box as shown in
Figure~\ref{fig:segment_intersect_a}.
These errors can be corrected by taking the bounding box of their unions.

\begin{figure}[h]
  \centering
  \begin{subfigure}[h]{0.5\textwidth}
    \centering
    \caption{}\label{fig:segment_intersect_a}
  \end{subfigure}
  \begin{subfigure}[h]{0.5\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \caption{Example of errorneous segmentations correctable (a) and incorrectable (b)
  by merging their bounding boxes}
  \label{fig:segment_intersect}
\end{figure}

Similarly, templates which are sufficiently close to eachother may be merged,
but without special care, this may quickly result in excessively large groupings.

\subsubsection{Variation in granularity}
There exists a variance in granularity for the extracted templates, in which
some sections of song are mostly connected to form a single template, and others
are disconnected, leaving templates with single syllables \textbf{right word?}
and templates with entire sections of song.
This is a similar to the observation in \textbf{spatial inclusion}.

\textbf{what to do about it}
\textbf{is it a problem}

\begin{figure}[!htb]
  \centering
  \caption{Example of selected templates with varying granularity}
\end{figure}


\subsubsection{inter-template correlation}
some templates may correlate with eachother, should they be merged?

It can also be argued that templates with little to know intercorrelation may be
independent anomalies such as noise in the signal or other sounds irrelevant to
the subject species.

\begin{figure}[!htb]
  \centering
  \begin{subfigure}[h]{0.2\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \begin{subfigure}[h]{0.2\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \begin{subfigure}[h]{0.2\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \begin{subfigure}[h]{0.2\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \begin{subfigure}[h]{0.2\textwidth}
    \centering
    \caption{}
  \end{subfigure}
  \caption{A selection of very similar segments}
\end{figure}

\subsubsection{Species-specific template statistics}
It may be possible to use information regarding average dimensionality and mean
frequency information to determine the relevance likelyhood of a particular template.
Such metrics require an existing set of validated templates, which may be gathered
by filtering a non discriminated set of templates by their measures importances.

Figure~\ref{fig:bandlimnit} shows how the birdx song doesn't use vocalisations
under 123 Hz.

\begin{figure}[!htb]
  \centering
  \caption{Example of a bird song with a principal frequency range}
  \label{fig:bandlimit}
\end{figure}
