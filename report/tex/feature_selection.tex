\section{Template Extraction}
Before we can extract template images for cross-correlation, they must first be
identified in the source spectrograms.
For this to be viable at any level of consistency, spectrograms must undergo
noise reduction and segmentation.
This section details the mechanisms developed for preprocessing spectrogram
images and filtering segments so that only relevant templates are included for
extraction.

Each spectrogram is processed in sequence using functionality provided by the
Python OpenCV library, and immediately stored on disk.
Parallelisation is possible here, but the computational cost of this stage is
not large enough to justify sparing development time on this aspect at the time.

\input{tex/sgram_preprocessing}

\subsection{Basic Selection and Extraction}\label{sec:template_select}
With optimal results the segments represent parts of song at the desired
granularity, from elements to phrases.
This is unfortunately not the case.
Noise may persist after preprocessing, and new deformations may appear, such as
incorrectly joined or incomplete segments.

Some effort is taken to reduce the number of undesireable templates.
In addition to noise, undesireable templates include extremely specific or
extremely generalised templates.

For example, if a sound is featured in a single instance of bird song, but not
in any other recording of songs of that species, then it is an extreme outlier,
which may occur due to a bird's individual expression or external sources.
It is non trivial to detect outliers during feature extraction, but because
random forests are generally insensitive to this type of outlier, we do not
treat these in this stage.

On the other hand, generalised templates are easier to detect.
Such templates will have a very faint structure (low contrast), or a complete
lack of structure.
These may be analysed directly and ignored, as they are likely to correlate,
although very weakly, to the majority of spectrograms irrespective of the
species.

Although these rejections bring a theoretical boost to classifier accuracy and
performance, they mainly benefit performance by reducing the number of
cross-correlations computed.

\subsubsection{Selection mechanism}
Complete elimination of all undesireable features is impossible without also
removing desireable features.
A balance must therefore be struck, in both preprocessing and selection stages.
Performing selection manually is extremely time consuming given the quantity
of pixel sections.
Selection is therefore done automatically by considering the dimensionality and
pixel values of each template.\\


Templates with the following properties are automatically rejected:
\begin{itemize}[noitemsep]
  \item \textbf{Area smaller than 50 pixels:} Templates with small dimensions
    are too small to be of any significance and are most likely noise or
    artefacts from preprocessing;

  \item \textbf{Area larger than 10000 pixels:} Templates with extremely large
    dimensions are most likely artefacts from preprocessing, high intensity
    noise or continuous external noises.
    It is possible for sections of song to be merged together into a single
    pixel region due to preprocessing errors.

  \item \textbf{Minimum pixel intensity greater than the average for the
    spectrogram:} attempt at reducing "boring" templates
    but it doesnt make sense
\end{itemize}


\subsubsection{Extraction mechanism}\label{sec:extract}

A bounding box is computed for the contours of each segment, which is then used
to extract a template from the original spectrogram image.
Once selection is performed for a particular pixel region, it's bounding box is
expanded by 10 pixels in each direction, and that region is extracted from the
original, unprocessed spectrogram.
This forms a single template.
The template is then blurred using Gaussian filtering with a sigma of 1.5.

The reason for blurring is to reduce the dimensionality of the template, which
brings performance boosts to template matching (described in
Section~\ref{sec:ccm}) since the template may now be reduced in size.

Blurring the template also improves it's generality, which makes matches more
likely.
Special consideration must be taken in order to ensure templates are not overly
generalised, as this will cause excess ambiguity amongst templates.



\subsection{Guided Template Elimination}
It is desireable to reduce the template count further by recognizing aspects which
make for good templates. This subsection outlines some speculative options for
selecting better templates, and reducing those which would have a low importance
score after training and classification.

\subsubsection{Image contrast}
It can be argued that templates with low local contrast contain insufficient
information to be meaningful in any way during template matching.
Templates with a low contrast match against much of any image, resulting in an
increase in noise.
Implicitly \textbf{is implicitly the right word?} such templates have a high
correlation with not only the species from which it was extracted but with all
species.
\textbf{show some images, maybe graphs of correlation}

\subsubsection{Spatial inclusion}
Due to the imperfect nature of the preprocessing methods used, gaps and
inconsistencies in structure appear in the thresholded spectrogram.
These inconsistencies are present also in repeated components in a bird song,
at all levels of granularity.
This causes multiple templates to be extracted for a single component in some
instances, and single larger blocks to be extracted in others.

In many of these cases, one template's bounding box intersects or is contained
entirely within another template's bounding box.
Merging these templates by extracting the bounding box of the union of the two
or more templates may result in more consistent extractions.
\textbf{show some images}

Similarly, templates which are sufficiently close to eachother may be merged,
but care must be taken not to form extremely large templates.

\subsubsection{Variation in granularity}
There exists a variance in granularity for the extracted templates, in which
some sections of song are mostly connected to form a single template, and others
are disconnected, leaving templates with single syllables \textbf{right word?}
and templates with entire sections of song.
This is a similar to the observation in \textbf{spatial inclusion}.

\textbf{what to do about it}
\textbf{is it a problem}


\subsubsection{inter-template correlation}
some templates may correlate with eachother, should they be merged?

It can also be argued that templates with little to know intercorrelation may be
independent anomalies such as noise in the signal or other sounds irrelevant to
the subject species.

\subsubsection{Species-specific template statistics}
It may be possible to use information regarding average dimensionality and mean
frequency information to determine the relevance likelyhood of a particular template.
Such metrics require an existing set of validated templates, which may be gathered
by filtering a non discriminated set of templates by their measures importances.
